<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>세계시간 TV</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        html, body {
            width: 100%;
            height: 100%;
            background: #000;
            overflow: hidden;
            cursor: none;
        }

        #tv-container {
            width: 100%;
            height: 100%;
            position: relative;
        }

        .slide {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 0.8s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .slide.active {
            opacity: 1;
        }

        .slide-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        /* YouTube 슬라이드 */
        .youtube-slide iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* BGM 플레이어 (숨김) */
        #bgm-player {
            position: fixed;
            bottom: -1000px;
            left: -1000px;
            width: 1px;
            height: 1px;
            pointer-events: none;
            opacity: 0;
        }

        #world-map-slide {
            z-index: 1;
        }

        #clocks-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none;
        }

        .time-text {
            position: absolute;
            transform: translate(-50%, -50%);
            font-family: 'Pretendard', 'Malgun Gothic', 'Arial', sans-serif;
            font-size: 1.4vw;
            font-weight: 800;
            color: #000;
            line-height: normal;
            text-shadow:
                -2px -2px 0 #fff,
                2px -2px 0 #fff,
                -2px 2px 0 #fff,
                2px 2px 0 #fff,
                0 0 10px rgba(255,255,255,0.9);
            font-feature-settings: "tnum";
            font-variant-numeric: tabular-nums;
            white-space: nowrap;
        }

        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            color: #fff;
            font-family: 'Pretendard', 'Malgun Gothic', sans-serif;
        }

        #loading.hidden { display: none; }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255,255,255,0.2);
            border-top-color: #4da6ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        #status {
            position: fixed;
            bottom: 20px;
            left: 20px;
            color: rgba(255,255,255,0.3);
            font-size: 12px;
            font-family: monospace;
            z-index: 100;
        }

        /* 하단 현재시간 바 */
        #time-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 60px;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 200;
        }

        #current-time {
            font-family: 'Pretendard', 'Malgun Gothic', sans-serif;
            font-size: 32px;
            font-weight: 700;
            color: #fff;
            letter-spacing: 2px;
        }

        #current-date {
            font-family: 'Pretendard', 'Malgun Gothic', sans-serif;
            font-size: 16px;
            color: rgba(255, 255, 255, 0.7);
            margin-left: 20px;
        }
    </style>
</head>
<body>
    <div id="loading">
        <div class="loading-spinner"></div>
        <p>로딩 중...</p>
    </div>

    <!-- 상단 현재시간 바 -->
    <div id="time-bar">
        <span id="current-time">00:00:00</span>
        <span id="current-date">2024년 1월 1일 월요일</span>
    </div>

    <div id="tv-container">
        <div id="world-map-slide" class="slide">
            <img src="https://cdn.imweb.me/upload/S20221123700ca8cd5ea82/fa5b65761fcbb.jpg" alt="세계지도" class="slide-image">
            <div id="clocks-layer"></div>
        </div>
        <div id="slides-container"></div>
    </div>

    <!-- BGM Player (hidden) -->
    <div id="bgm-player"></div>

    <div id="status"></div>

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>

    <!-- YouTube IFrame API -->
    <script src="https://www.youtube.com/iframe_api"></script>

    <script>
        // YouTube API 준비 완료 플래그
        let ytApiReady = false;
        function onYouTubeIframeAPIReady() {
            ytApiReady = true;
            console.log('[TV] YouTube API 준비 완료');
        }

        (function() {
            const locations = [
                { name: '대한민국', zone: 'Asia/Seoul', top: 54, left: 43.5 },
                { name: '중국', zone: 'Asia/Shanghai', top: 50, left: 38 },
                { name: '러시아', zone: 'Europe/Moscow', top: 34, left: 37 },
                { name: '카자흐스탄', zone: 'Asia/Almaty', top: 45, left: 31 },
                { name: '두바이', zone: 'Asia/Dubai', top: 60, left: 28 },
                { name: '오스트레일리아', zone: 'Australia/Sydney', top: 73.5, left: 44 },
                { name: '미국', zone: 'America/New_York', top: 48.5, left: 69 },
                { name: '캐나다', zone: 'America/Toronto', top: 37, left: 67 },
                { name: '그린란드', zone: 'America/Nuuk', top: 21, left: 82 },
                { name: '브라질', zone: 'America/Sao_Paulo', top: 68, left: 79 },
                { name: '아이슬란드', zone: 'Atlantic/Reykjavik', top: 33, left: 13 }
            ];

            let photos = [];
            let youtubeVideos = [];
            let bgmUrl = '';
            let intervalSeconds = 15;
            let currentSlideIndex = 0;
            let slideTimer = null;
            let bgmPlayer = null;
            let currentYTPlayer = null;  // 현재 재생 중인 YouTube 플레이어
            let isYoutubeSlide = false;  // 현재 YouTube 슬라이드인지 여부

            const loadingEl = document.getElementById('loading');
            const worldMapSlide = document.getElementById('world-map-slide');
            const clocksLayer = document.getElementById('clocks-layer');
            const slidesContainer = document.getElementById('slides-container');
            const bgmPlayerEl = document.getElementById('bgm-player');
            const statusEl = document.getElementById('status');
            const currentTimeEl = document.getElementById('current-time');
            const currentDateEl = document.getElementById('current-date');

            async function init() {
                initClocks();
                await loadSettings();
                buildSlides();
                startSlideshow();
                hideLoading();
                requestFullscreen();

                // 실시간 구독은 에러 무시
                try {
                    subscribeToRealtime();
                } catch(e) {
                    console.log('실시간 구독 실패:', e);
                }
            }

            // Supabase에서 설정 불러오기
            async function loadSettings() {
                updateStatus('설정 로딩 중...');

                try {
                    const data = await loadSettingsFromDB();

                    if (data) {
                        intervalSeconds = data.interval_seconds || 15;
                        photos = data.photos || [];
                        youtubeVideos = data.youtube_videos || [];
                        bgmUrl = data.bgm_url || '';
                        updateStatus(`로드 완료: 사진 ${photos.length}장, YouTube ${youtubeVideos.length}개`);
                        setupBgm();
                    } else {
                        updateStatus('기본 설정 사용');
                    }
                } catch(e) {
                    console.log('설정 로드 에러:', e);
                    updateStatus('DB 연결 실패 - 기본 설정 사용');
                }
            }

            // 실시간 변경 감지
            function subscribeToRealtime() {
                subscribeToChanges((newData) => {
                    updateStatus('설정 변경 감지!');
                    intervalSeconds = newData.interval_seconds || 15;
                    photos = newData.photos || [];
                    youtubeVideos = newData.youtube_videos || [];
                    const newBgmUrl = newData.bgm_url || '';

                    // BGM이 변경되었으면 업데이트
                    if (newBgmUrl !== bgmUrl) {
                        bgmUrl = newBgmUrl;
                        setupBgm();
                    }

                    buildSlides();
                    restartSlideshow();
                    updateStatus(`업데이트: 사진 ${photos.length}장, YouTube ${youtubeVideos.length}개`);
                });
            }

            // YouTube URL에서 비디오 ID 추출
            function extractYoutubeId(url) {
                const patterns = [
                    /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\?\/]+)/,
                    /youtube\.com\/shorts\/([^&\?\/]+)/
                ];
                for (const pattern of patterns) {
                    const match = url.match(pattern);
                    if (match) return match[1];
                }
                return null;
            }

            // BGM 설정
            function setupBgm() {
                bgmPlayerEl.innerHTML = '';

                if (!bgmUrl) {
                    updateStatus('BGM 없음');
                    return;
                }

                const videoId = extractYoutubeId(bgmUrl);
                if (!videoId) return;

                // YouTube iframe으로 BGM 재생 (자동재생, 반복, 음소거 해제)
                const iframe = document.createElement('iframe');
                iframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=1&loop=1&playlist=${videoId}&controls=0&showinfo=0&rel=0&modestbranding=1`;
                iframe.allow = 'autoplay; encrypted-media';
                iframe.style.cssText = 'width: 1px; height: 1px;';
                bgmPlayerEl.appendChild(iframe);

                updateStatus('BGM 재생 중...');
            }

            function initClocks() {
                locations.forEach((loc, index) => {
                    const el = document.createElement('div');
                    el.className = 'time-text';
                    el.id = `clock-${index}`;
                    el.style.top = loc.top + '%';
                    el.style.left = loc.left + '%';
                    clocksLayer.appendChild(el);
                });
                updateClocks();
                setInterval(updateClocks, 1000);
            }

            function updateClocks() {
                const now = new Date();

                // 상단 현재 시간 업데이트
                currentTimeEl.textContent = new Intl.DateTimeFormat('ko-KR', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false,
                    timeZone: 'Asia/Seoul'
                }).format(now);

                currentDateEl.textContent = new Intl.DateTimeFormat('ko-KR', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    weekday: 'long',
                    timeZone: 'Asia/Seoul'
                }).format(now);

                // 세계 시간 업데이트
                locations.forEach((loc, index) => {
                    const el = document.getElementById(`clock-${index}`);
                    if (el) {
                        el.textContent = new Intl.DateTimeFormat('ko-KR', {
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit',
                            hour12: false,
                            timeZone: loc.zone
                        }).format(now);
                    }
                });
            }

            function buildSlides() {
                slidesContainer.innerHTML = '';

                // 사진 슬라이드 추가
                photos.forEach((photo, index) => {
                    const slide = document.createElement('div');
                    slide.className = 'slide photo-slide';
                    slide.dataset.index = index;
                    slide.dataset.type = 'photo';

                    const img = document.createElement('img');
                    img.src = photo.url;
                    img.alt = `사진 ${index + 1}`;
                    img.className = 'slide-image';

                    slide.appendChild(img);
                    slidesContainer.appendChild(slide);
                });

                // YouTube 슬라이드 추가
                youtubeVideos.forEach((video, index) => {
                    const slide = document.createElement('div');
                    slide.className = 'slide youtube-slide';
                    slide.dataset.index = photos.length + index;
                    slide.dataset.type = 'youtube';
                    slide.dataset.videoId = video.videoId;

                    // YouTube 플레이어용 div (IFrame API 사용)
                    const playerDiv = document.createElement('div');
                    playerDiv.id = `yt-player-${video.videoId}`;
                    playerDiv.style.cssText = 'width: 100%; height: 100%;';

                    slide.appendChild(playerDiv);
                    slidesContainer.appendChild(slide);
                });

                currentSlideIndex = 0;
                showSlide(0);
            }

            function showSlide(index) {
                const totalSlides = 1 + photos.length + youtubeVideos.length;
                if (index >= totalSlides) index = 0;
                if (index < 0) index = totalSlides - 1;
                currentSlideIndex = index;

                // 모든 슬라이드 비활성화
                worldMapSlide.classList.remove('active');
                document.querySelectorAll('.photo-slide').forEach(s => s.classList.remove('active'));
                document.querySelectorAll('.youtube-slide').forEach(s => {
                    s.classList.remove('active');
                });

                // 기존 YouTube 플레이어 정리
                if (currentYTPlayer) {
                    try {
                        currentYTPlayer.stopVideo();
                        currentYTPlayer.destroy();
                    } catch(e) {}
                    currentYTPlayer = null;
                }

                if (index === 0) {
                    // 세계지도 슬라이드
                    worldMapSlide.classList.add('active');
                    isYoutubeSlide = false;
                    startSlideshow();
                } else if (index <= photos.length) {
                    // 사진 슬라이드
                    const target = document.querySelector(`.photo-slide[data-index="${index - 1}"]`);
                    if (target) target.classList.add('active');
                    isYoutubeSlide = false;
                    startSlideshow();
                } else {
                    // YouTube 슬라이드
                    const target = document.querySelector(`.youtube-slide[data-index="${index - 1}"]`);
                    if (target) {
                        target.classList.add('active');
                        const videoId = target.dataset.videoId;

                        // 타이머 중지 (영상 끝날 때까지 대기)
                        if (slideTimer) clearInterval(slideTimer);
                        isYoutubeSlide = true;

                        // YouTube IFrame API로 플레이어 생성
                        if (ytApiReady && videoId) {
                            // 기존 플레이어 제거
                            if (currentYTPlayer) {
                                try { currentYTPlayer.destroy(); } catch(e) {}
                            }

                            const playerDiv = target.querySelector(`#yt-player-${videoId}`);
                            if (playerDiv) {
                                // 새 div 생성 (플레이어가 div를 대체하므로)
                                playerDiv.id = `yt-player-${videoId}-${Date.now()}`;

                                currentYTPlayer = new YT.Player(playerDiv.id, {
                                    videoId: videoId,
                                    width: '100%',
                                    height: '100%',
                                    playerVars: {
                                        autoplay: 1,
                                        mute: 1,
                                        controls: 0,
                                        showinfo: 0,
                                        rel: 0,
                                        modestbranding: 1,
                                        loop: 0,  // 반복 안함 - 끝나면 다음 슬라이드로
                                        playsinline: 1
                                    },
                                    events: {
                                        onStateChange: function(event) {
                                            // 영상 종료 시 (state = 0)
                                            if (event.data === YT.PlayerState.ENDED) {
                                                onYoutubeVideoEnd();
                                            }
                                        },
                                        onError: function(event) {
                                            console.log('YouTube 에러:', event.data);
                                            onYoutubeVideoEnd();
                                        }
                                    }
                                });
                                updateStatus('YouTube 재생 중...');
                            }
                        }
                    }
                }
            }

            function startSlideshow() {
                if (slideTimer) clearInterval(slideTimer);
                // YouTube 슬라이드가 아닐 때만 타이머 시작
                if (!isYoutubeSlide) {
                    slideTimer = setInterval(() => {
                        showSlide(currentSlideIndex + 1);
                    }, intervalSeconds * 1000);
                }
            }

            function restartSlideshow() {
                startSlideshow();
            }

            // YouTube 영상 종료 시 다음 슬라이드로
            function onYoutubeVideoEnd() {
                updateStatus('YouTube 영상 종료 - 다음 슬라이드');
                isYoutubeSlide = false;
                showSlide(currentSlideIndex + 1);
                startSlideshow();
            }

            function hideLoading() {
                setTimeout(() => loadingEl.classList.add('hidden'), 1000);
            }

            function requestFullscreen() {
                // 화면 클릭 시 전체화면 (보안 정책상 자동 전체화면 불가)
                document.body.addEventListener('click', () => {
                    const el = document.documentElement;
                    try {
                        if (!document.fullscreenElement && !document.webkitFullscreenElement) {
                            if (el.requestFullscreen) el.requestFullscreen();
                            else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
                        }
                    } catch (e) {}
                }, { once: true });

                // 전체화면 안내 메시지 표시
                updateStatus('화면을 클릭하면 전체화면이 됩니다');
            }

            function updateStatus(msg) {
                statusEl.textContent = msg;
                console.log('[TV]', msg);
            }

            init();
        })();
    </script>
</body>
</html>
